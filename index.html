import Text "mo:core/Text";
import Array "mo:core/Array";
import Map "mo:core/Map";
import Iter "mo:core/Iter";
import Order "mo:core/Order";
import Runtime "mo:core/Runtime";

actor {
  type Notification = {
    id : Nat;
    title : Text;
    message : Text;
    isActive : Bool;
  };

  type Review = {
    id : Nat;
    studentName : Text;
    feedback : Text;
    rating : Nat; // 1-5 stars
  };

  type ServiceCard = {
    id : Nat;
    title : Text;
    description : Text;
    redirectUrl : Text;
  };

  module Notification {
    public func compare(notification1 : Notification, notification2 : Notification) : Order.Order {
      Nat.compare(notification1.id, notification2.id);
    };
  };

  module Review {
    public func compare(review1 : Review, review2 : Review) : Order.Order {
      Nat.compare(review1.id, review2.id);
    };
  };

  module ServiceCard {
    public func compare(serviceCard1 : ServiceCard, serviceCard2 : ServiceCard) : Order.Order {
      Nat.compare(serviceCard1.id, serviceCard2.id);
    };
  };

  let notifications = Map.empty<Nat, Notification>();
  let reviews = Map.empty<Nat, Review>();
  let serviceCards = Map.empty<Nat, ServiceCard>();

  // Initialize with some default data
  public shared ({ caller }) func initialize() : async () {
    if (notifications.size() > 0) { Runtime.trap("Already initialized") };

    // Add default notifications
    let defaultNotifications = [
      {
        id = 1;
        title = "Admission Update";
        message = "MBBS counselling registration is now open!";
        isActive = true;
      },
      {
        id = 2;
        title = "Important Notice";
        message = "BDS application deadline extended to next month.";
        isActive = true;
      },
    ];

    for (notification in defaultNotifications.values()) {
      notifications.add(notification.id, notification);
    };

    // Add default reviews
    let defaultReviews = [
      {
        id = 1;
        studentName = "John Doe";
        feedback = "Excellent guidance and support throughout the admission process.";
        rating = 5;
      },
      {
        id = 2;
        studentName = "Jane Smith";
        feedback = "Professional and reliable service. Highly recommended!";
        rating = 4;
      },
      {
        id = 3;
        studentName = "Michael Johnson";
        feedback = "Helped me secure my dream medical college. Thank you!";
        rating = 5;
      },
    ];

    for (review in defaultReviews.values()) {
      reviews.add(review.id, review);
    };

    // Add default service cards
    let defaultServiceCards = [
      {
        id = 1;
        title = "MBBS Counselling";
        description = "Comprehensive guidance for MBBS admissions.";
        redirectUrl = "packages.html";
      },
      {
        id = 2;
        title = "BDS Counselling";
        description = "Expert support for BDS course admissions.";
        redirectUrl = "packages.html";
      },
      {
        id = 3;
        title = "AYUSH Programs";
        description = "Admission assistance for AYUSH courses.";
        redirectUrl = "packages.html";
      },
      {
        id = 4;
        title = "Other Medical Courses";
        description = "Guidance for various medical programs.";
        redirectUrl = "packages.html";
      },
    ];

    for (serviceCard in defaultServiceCards.values()) {
      serviceCards.add(serviceCard.id, serviceCard);
    };
  };

  // Notification Management
  public shared ({ caller }) func addNotification(title : Text, message : Text) : async () {
    let id = notifications.size() + 1;
    let notification : Notification = {
      id;
      title;
      message;
      isActive = true;
    };
    notifications.add(id, notification);
  };

  public shared ({ caller }) func updateNotification(id : Nat, title : Text, message : Text, isActive : Bool) : async () {
    switch (notifications.get(id)) {
      case (null) { Runtime.trap("Notification not found") };
      case (?_) {
        let updatedNotification : Notification = {
          id;
          title;
          message;
          isActive;
        };
        notifications.add(id, updatedNotification);
      };
    };
  };

  public shared ({ caller }) func deleteNotification(id : Nat) : async () {
    if (not notifications.containsKey(id)) {
      Runtime.trap("Notification not found");
    };
    notifications.remove(id);
  };

  public query ({ caller }) func getActiveNotifications() : async [Notification] {
    notifications.values().toArray().filter(func(n) { n.isActive }).sort();
  };

  // Review Management
  public shared ({ caller }) func addReview(studentName : Text, feedback : Text, rating : Nat) : async () {
    if (rating < 1 or rating > 5) {
      Runtime.trap("Rating must be between 1 and 5");
    };
    let id = reviews.size() + 1;
    let review : Review = {
      id;
      studentName;
      feedback;
      rating;
    };
    reviews.add(id, review);
  };

  public query ({ caller }) func getAllReviews() : async [Review] {
    reviews.values().toArray().sort();
  };

  // Service Card Management
  public shared ({ caller }) func addServiceCard(title : Text, description : Text, redirectUrl : Text) : async () {
    let id = serviceCards.size() + 1;
    let serviceCard : ServiceCard = {
      id;
      title;
      description;
      redirectUrl;
    };
    serviceCards.add(id, serviceCard);
  };

  public query ({ caller }) func getAllServiceCards() : async [ServiceCard] {
    serviceCards.values().toArray().sort();
  };
};
